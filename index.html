<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Court File App – Step 6</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;margin:0;padding:10px}
.section{background:#fff;padding:10px;margin-bottom:12px;border-radius:6px}
h3{margin:0 0 6px 0}
input,button{width:100%;padding:10px;margin:6px 0;font-size:15px}
button{background:#1976d2;color:#fff;border:none;border-radius:4px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #333;padding:5px;font-size:12px}
tr.active{background:#e3f2fd}

/* SCANNER */
#scannerWrap{
  position:fixed;inset:0;background:#000;display:none;z-index:999
}
#video{width:100vw;height:80vh;object-fit:cover}
#scanLine{position:absolute;top:40%;left:10%;width:80%;height:4px;background:red}
#closeScan{background:#c62828}
</style>
</head>

<body>

<div class="section">
  <h3>Working Date</h3>
  <input type="date" id="workDate">
</div>

<div class="section">
  <h3>Excel Upload</h3>
  <input type="file" id="excelFile">
  <button onclick="uploadExcel()">Upload Excel</button>
</div>

<div class="section">
  <h3>Scan Action</h3>
  <button onclick="scanSent()">Scan for SENT</button>
  <button onclick="scanReceived()">Scan for RECEIVED</button>
</div>

<div class="section">
  <h3>Next Date (Selected File)</h3>
  <input type="date" id="nextDate">
  <button onclick="saveNextDate()">Save Next Date</button>
</div>

<table id="table"></table>

<!-- SCANNER -->
<div id="scannerWrap">
  <div style="position:relative;">
    <video id="video"></video>
    <div id="scanLine"></div>
  </div>
  <button id="closeScan" onclick="stopScanner()">Close Scanner</button>
</div>

<script>
let currentData = [];
let selectedIndex = null;
let scanMode = "";
let codeReader;

/* LOAD DATE DATA */
workDate.addEventListener("change",()=>{
  let saved = localStorage.getItem("court_"+workDate.value);
  currentData = saved ? JSON.parse(saved) : [];
  selectedIndex = null;
  drawTable(currentData);
});

/* EXCEL UPLOAD (COLUMN POSITION BASED) */
function uploadExcel(){
  if(!workDate.value){ alert("Pehle date select karo"); return; }
  let file = excelFile.files[0];
  if(!file){ alert("No Excel selected"); return; }

  let reader = new FileReader();
  reader.onload = e=>{
    let wb = XLSX.read(e.target.result,{type:"binary"});
    let rows = XLSX.utils.sheet_to_json(
      wb.Sheets[wb.SheetNames[0]],
      {header:1, defval:""}
    );
    rows.shift();

    currentData = rows.map(r=>({
      srno:r[0]||"",
      caseno:String(r[1]||"").trim(),
      partyname:r[2]||"",
      section:r[3]||"",
      ps:r[4]||"",
      sent:"",
      received:"",
      receiveddate:"",
      nextdate:""
    }));

    localStorage.setItem("court_"+workDate.value, JSON.stringify(currentData));
    alert("Excel uploaded & saved");
    drawTable(currentData);
  };
  reader.readAsBinaryString(file);
}

/* TABLE CLICK (SELECT FILE) */
function drawTable(data){
  table.innerHTML="";
  if(!data.length) return;
  let h = Object.keys(data[0]);
  table.innerHTML="<tr>"+h.map(x=>"<th>"+x+"</th>").join("")+"</tr>";

  data.forEach((r,i)=>{
    let tr = document.createElement("tr");
    tr.onclick=()=>{
      selectedIndex=i;
      drawTable(data);
    };
    if(i===selectedIndex) tr.className="active";
    tr.innerHTML=h.map(x=>"<td>"+(r[x]||"")+"</td>").join("");
    table.appendChild(tr);
  });
}

/* SAVE NEXT DATE */
function saveNextDate(){
  if(selectedIndex===null){
    alert("Pehle table se file select karo");
    return;
  }
  let nd = nextDate.value;
  if(!nd){ alert("Next date select karo"); return; }

  currentData[selectedIndex].nextdate = nd;
  localStorage.setItem("court_"+workDate.value, JSON.stringify(currentData));
  alert("Next Date Saved ✅");
  drawTable(currentData);
}

/* SCAN FUNCTIONS */
function scanSent(){ scanMode="SENT"; startScanner(); }
function scanReceived(){ scanMode="RECEIVED"; startScanner(); }

async function startScanner(){
  if(!currentData.length){ alert("No data"); return; }
  scannerWrap.style.display="block";

  codeReader = new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS,
      [ZXing.BarcodeFormat.CODE_128]]])
  );

  const devices = await codeReader.listVideoInputDevices();
  const cam = devices.find(d=>d.label.toLowerCase().includes("back"))||devices[0];

  codeReader.decodeFromVideoDevice(cam.deviceId,"video",(res)=>{
    if(res){ handleScan(res.text); }
  });
}

function stopScanner(){
  if(codeReader){ codeReader.reset(); codeReader=null; }
  scannerWrap.style.display="none";
}

function handleScan(code){
  stopScanner();
  let row = currentData.find(r=>r.caseno===code.trim());
  if(!row){ alert("Mismatch ❌"); return; }

  if(scanMode==="SENT"){
    if(row.sent){ alert("Already Sent ❌"); return; }
    row.sent="YES"; alert("Sent ✅");
  }
  if(scanMode==="RECEIVED"){
    if(!row.sent){ alert("Not Sent Yet ❌"); return; }
    row.received="YES";
    row.receiveddate=new Date().toLocaleDateString();
    alert("Received ✅");
  }
  localStorage.setItem("court_"+workDate.value, JSON.stringify(currentData));
  drawTable(currentData);
}
</script>

</body>
</html>
